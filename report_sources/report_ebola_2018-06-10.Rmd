---
title: "Modelling further incidence of the Ebola Virus Disease (EVD) outbreak in Bikoro, DRC"
author: "Thibaut Jombart, Adom San Koffi for the DRC Incident Management Team, Kinshasa"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---



```{r, echo = FALSE, warning = FALSE}
options(width = 100)

knitr::opts_chunk$set(
  fig.width = 7, 
  fig.height = 7,
  dev = 'png',
  fig.path = "figs/"
)

odir <- getwd()

```




```{r load_pkg}

library(EpiEstim)
library(epitrix)
library(distcrete)
library(incidence)
library(projections)
library(ggplot2)
library(adegenet)
library(earlyR)
library(here)

```


## Entering the data

The data are read from the file 'data.csv', which must fulfill:

- the first column named 'onset'

- the second column named 'death'

- all entries are dates using the format *YYYY-MM-DD*, so that 4th February 1982
is *1982-02-04*; when data is missing, leave blank

Dates of onset are mandatory. Dates of death are optional, and are not used in
the modelling (only for graphical purpose). Make sure the number of dates in
`onset` and `death` is the same.

```{r load_data}

dat <- read.csv(here("data/data_2018-06-13.csv"))
dat$onset <- as.Date(as.character(dat$onset))
dat$death <- as.Date(as.character(dat$death))

onset <- dat$onset
death <- dat$death

day0 <- min(onset)
death_int <- as.integer(death - day0)
onset_int <- as.integer(onset - day0)

id <- paste0("case_", 1:length(death))

df <- data.frame(id, onset, death, onset_int, death_int)
df

df_long <- data.frame(id = rep(id, 2),
                      date = c(df$onset, df$death),
		      date_int = c(df$onset_int, df$death_int),
		      event = rep(c("onset", "death"), each = nrow(df)))

show_data <- function(onset = dat$onset, death = dat$death,
                      add = FALSE, ...) {
  par(mar = c(5.1, 2.1, 4.1, 1.1))

  all_dates <- na.omit(c(onset, death))
  x_range <- range(all_dates) + c(-1, 1)
  
  if (add) {
    points(onset, seq_along(onset), pch = 20, cex = 2, ...)
  } else {
    plot(onset, seq_along(onset), pch = 20, cex = 2, xlim = x_range,
         xlab = "", ylab = "", yaxt = "n", ...)
  }
    
  points(death, seq_along(death), pch = 20, cex = 2, xlim = x_range)

  to_keep <- !is.na(onset) & !is.na(death)
  segments(x0 = onset[to_keep], x1 = death[to_keep],
           y0 = which(to_keep), y1 = which(to_keep),
           lwd = 3)
}

show_data()

```




The serial interval is also considered as a given: we use estimates from the
previous EVD outbreak in West Africa. It is defined as a discretized Gamma
distribution with mean 15.3 days and standard deviation 9.3. This is obtained
using the package `distcrete`:

```{r si_param}
si_param <- epitrix::gamma_mucv2shapescale(15.3, 9.3/15.3)
si_param
si <- distcrete("gamma", shape = si_param$shape,
                scale = si_param$scale,
		interval = 1L, w = 0L)

plot(1:60, si$d(1:60),
     main = "Serial interval distribution",
     xlab = "Days after symptoms",
     ylab = "Probability of symptoms in secondary case",
     col = heat.colors(60),
     type = "h", lwd = 8, lend = 1)
 
```



## Estimation of the reproduction number (*R*)

Infectiousness is measured by the reproduction number (*R*), defined as the
average number of secondary cases which infectious cases can cause. The new
package *earlyR* has been developed to estimate *R* from limited data we have
from the early stages of an outbreak. We also use *incidence* (devel version
needed, installed by default on the RECON usb sticks) to compute and plot
incidence:

```{r estimation}

today <- Sys.Date()
i <- incidence(onset, last_date = today)
plot(i)
R_est <- get_R(i, si = si, max_R = 4)
R_est

```

The distribution of likely *R* is:


```{r R}

plot(R_est)

set.seed(1)
R_sample <- sample_R(R_est, 1000)
hist(R_sample, col = "grey", border = "white",
     xlab = "Reproduction number",
     main = "Sample of likely R values")

## main statitics
summary(R_sample)

## 95% credibility interval
ci95 <- quantile(R_sample, c(.05/2, 1 - .05/2))
ci95

```


## Infectiousness over time


*lambdas* represent the relative force of infection coming from the combined
 infectiousness of past confirmed / probable cases. It can be visualised
 alongside the data using:

```{r infectiousness}

n_cases <- nrow(dat)

plot(R_est, "lambda", scale = n_cases, xlim = c(day0, today + 30), yaxt = "n")

show_data(add = TRUE)
abline(v = today + .5, lty = 2, lwd = 2)
legend("topright", pch = 20, pt.cex = 2, col = c("red", "black"),
       legend = c("Onset", "Death"), cex = 1.5, ncol = 2,
       bg = "white", inset = .02)
y_position <- n_cases / 2
arrows(today + 2, y_position, today+30, y_position, code = 3, lwd = 2)
text(today + 16.5, y_position * 1.1, lab = "Remaining force \nof infection",
     adj = c(.5, .5), cex = 1.2)
box()

```





## Projections

Taken together, the current epicurve, the temporal evolution of the relative
force of infection and estimates of the reproduction number (*R*) can be used to
project potential future incidences. The new package *projections* has been
developed for this purpose. Here, we use 1,000 simulations to cover a large
range of possible outcomes:

```{r projections}

set.seed(1)

library(projections)


## make simulations

sim <- project(i, R_sample, si$d(1:100), n_days = 30,
               n_sim = 10000, R_fix_within = TRUE)
sim


## plot results

df_sim <- data.frame(date = attr(sim, "dates"),
                     incidence = as.integer(sim))

df_sim_condensed <- xyTable(df_sim)
df_sim_condensed$x <- as.Date(df_sim_condensed$x, origin = "1970-01-01")
df_sim_condensed <- data.frame(df_sim_condensed)

ggplot(df_sim_condensed, aes(x = x, y = y)) +
  geom_point(aes(size = number), alpha = .4) +
  geom_smooth(data = df_sim, aes(x = date, y = incidence)) +
  labs(x = "",
       y = "Predicted incidence",
       title = "Simulations: plausible scenarios")

```


The distribution of the total number of new cases in each simulation is:

```{r new_cases}

n_new_cases <- apply(sim, 2, sum)
hist(n_new_cases, nclass = 30, col = "grey", border = "white",
     main = "New cases in next 30 days in simulations",
     xlab = "Number of new cases over next 30 days")
     
```


From this, we can derive the probability that the next 30 days will have *xxx*
new cases or less:

```{r p_new_cases}

max_n <- max(n_new_cases)
p_n_cases <- sapply(0:max_n, function(i) mean(n_new_cases < i))
names(p_n_cases) <- paste("p <", 0:max_n)

plot(0:max_n, p_n_cases, type = "s",
     xlab = "x: projected new cases over next 30 days",
     ylab = "Proportion of simulations less than 'x'",
     main = "Cumulative distribution of projected new cases \nover next 30 days")

head(p_n_cases, 20)

```

The maximum likelihood reproduction number (R) is R = `r round(R_est$R_ml, 2)`,
with median R = `r round(median(R_sample),2)` and a 95% credibility interval
`r sprintf("[%.2f - %.2f]", ci95[1], ci95[2])`. The date of onset of the first
patient was estimated based on the recorded date of death. Ten thousand (10,000)
simulations were run to project potential daily incidence over the next 30
days. In summary:

- `r round(100 * p_n_cases[2])`% of these predict no new cases for the entire
period

- `r round(100 * mean(n_new_cases >= 1 & n_new_cases <= 10), 2)`% predict between 1
  and 10 cases for the entire period

- `r round(100 * mean(n_new_cases >= 11 & n_new_cases <= 50), 2)`% predict between 11
  and 50 cases for the entire period

- `r round(100 * mean(n_new_cases > 50), 2)`% predict more than 50 cases for the
  entire period



<br>
<br>
<br>

